<app-top-bar></app-top-bar>

<div class="mykpi-container">
  <app-menu></app-menu>

  <div class="mykpi-content">
    <div class="page-header">
      <h2>Bảng KPIs</h2>

        <div class="filters">
          <!-- Nếu user có nhiều role thì mới hiện dropdown -->
          <ng-container *ngIf="roles.length > 1; else oneRole">
            <select [(ngModel)]="selectedRole" (change)="onRoleChange()">
              <option *ngFor="let r of roles" [value]="r">{{getRoleLabel(r) }}</option>
            </select>
          </ng-container>
          <ng-template #oneRole>
            <span class="role-label">Role: {{ selectedRole }}</span>
          </ng-template>

          <!-- Dropdown chọn năm -->
          <select [(ngModel)]="selectedYear" (change)="onYearChange()">
            <option *ngFor="let y of years" [value]="y">{{ y }}</option>
          </select>
        </div>
      </div>

    <div class="table-card">
      <table class="kpi-table">
        <thead>
          <tr>
            <th style="width:50px">STT</th>
            <th style="width:90px">Mã KPI</th>
            <th>Chỉ tiêu đánh giá</th>
            <th style="width:80px">Mục Tiêu</th>
            <th style="width:80px">Trọng số</th>
            <th style="width:220px">Công thức tính</th>
            <th style="width:90px">Kết quả</th>
            <th style="width:90px">KPI</th>
            <th style="width:110px">Đánh giá</th>
          </tr>
        </thead>
        <tbody>
          <!-- === KPI Chức năng === -->
          <tr class="section-header">
            <td colspan="9">KPI Chức Năng</td>
          </tr>
          <tr *ngFor="let r of chucNang">
            <td class="center">{{ r.stt }}</td>
            <td class="center">{{ r.maKpi }}</td>
            <td class="left">{{ r.chiTieu }}</td>
            <td class="center">{{ r.mucTieu }}</td>
            <td class="center">{{ r.trongSo || '' }}</td>
            <td class="left">{{ r.congThuc }}</td>
            <td class="center">{{ r.ketQua }}</td>
            <td class="center">{{ r.kpi }}</td>
            <td class="center"></td> <!-- trống cho chi tiết -->
          </tr>
          <!-- Tổng KPI Chức năng -->
          <tr class="total-row">
            <td></td><td></td>
            <td class="left">TỔNG KPI CHỨC NĂNG</td>
            <td></td>
            <td class="center">{{ sumWeight(chucNang) }}%</td>
            <td></td>
            <td class="center"></td>
            <td class="center">{{ sumKpi(chucNang) ? sumKpi(chucNang)+'%' : 'Chưa có' }}</td>
            <td class="center">{{ getDanhGia(sumKpi(chucNang)) }}</td>
          </tr>

          <!-- === KPI Mục tiêu === -->
          <tr class="section-header">
            <td colspan="9">KPI Mục Tiêu</td>
          </tr>
          <tr *ngFor="let r of mucTieu">
            <td class="center">{{ r.stt }}</td>
            <td class="center">{{ r.maKpi }}</td>
            <td class="left">{{ r.chiTieu }}</td>
            <td class="center">{{ r.mucTieu }}</td>
            <td class="center">{{ r.trongSo || '' }}</td>
            <td class="left">{{ r.congThuc }}</td>
            <td class="center">{{ r.ketQua }}</td>
            <td class="center">{{ r.kpi }}</td>
            <td class="center"></td>
          </tr>
          <!-- Tổng KPI Mục tiêu -->
          <tr class="total-row">
            <td></td><td></td>
            <td class="left">TỔNG KPI MỤC TIÊU</td>
            <td></td>
            <td class="center">{{ sumWeight(mucTieu) }}%</td>
            <td></td>
            <td class="center"></td>
            <td class="center">{{ sumKpi(mucTieu) ? sumKpi(mucTieu)+'%' : 'Chưa có' }}</td>
            <td class="center">{{ getDanhGia(sumKpi(mucTieu)) }}</td>
          </tr>

          <!-- === KPI Tuân thủ === -->
          <tr class="section-header">
            <td colspan="9">KPI Tuân Thủ</td>
          </tr>
          <tr *ngFor="let r of tuanThu">
            <td class="center">{{ r.stt }}</td>
            <td class="center">{{ r.maKpi }}</td>
            <td class="left">{{ r.chiTieu }}</td>
            <td class="center">{{ r.mucTieu }}</td>
            <td class="center">{{ r.trongSo || '' }}</td>
            <td class="left">{{ r.congThuc }}</td>
            <td class="center">{{ r.ketQua }}</td>
            <td class="center">{{ r.kpi }}</td>
            <td class="center"></td>
          </tr>
          <!-- Tổng KPI Tuân thủ -->
          <tr class="total-row">
            <td></td><td></td>
            <td class="left">TỔNG KPI TUÂN THỦ</td>
            <td></td>
            <td class="center">{{ sumWeight(tuanThu) }}%</td>
            <td></td>
            <td class="center"></td>
            <td class="center">{{ sumKpi(tuanThu) ? sumKpi(tuanThu)+'%' : 'Chưa có'  }}</td>
            <td class="center">{{ getDanhGia(sumKpi(tuanThu)) }}</td>
          </tr>

          <!-- === KPI Tổng thể ở cuối === -->
          <tr class="grand-total">
            <td></td><td></td>
            <td class="left big">KPI TỔNG THỂ</td>
            <td></td>
            <td></td>
            <td class="left big">TỔNG KPI CHỨC NĂNG + TỔNG KPI MỤC TIÊU + TỔNG KPI TUÂN THỦ</td>
            <td></td>
            <td class="center big">{{ totalOverall() ? totalOverall()+'%' : 'Chưa có' }}</td>
            <td class="center big">{{ getDanhGia(totalOverall()) }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
